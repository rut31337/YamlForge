# DemoBuilder Authentication Guide

Complete guide for setting up Keycloak authentication with DemoBuilder.

## Overview

DemoBuilder supports optional Keycloak authentication through OAuth2 Proxy deployment. This provides enterprise-grade authentication with role-based access control while maintaining the flexibility to deploy without authentication for development or testing.

## Authentication Architecture

### Flow Diagram
```
User → Keycloak Login → OAuth2 Proxy → DemoBuilder (Streamlit)
```

### Components

1. **OAuth2 Proxy**: Handles OIDC authentication at ingress level
2. **Keycloak**: Identity provider and authentication server
3. **DemoBuilder**: Extracts user information from proxy headers
4. **OpenShift Route**: Directs traffic through OAuth2 Proxy when auth is enabled

### Authentication Flow

1. User accesses DemoBuilder route
2. OAuth2 Proxy intercepts request and redirects to Keycloak if not authenticated
3. After successful Keycloak login, OAuth2 Proxy forwards request with user headers
4. Streamlit application extracts user information from headers for session management

## Keycloak Configuration

### Realm Setup

1. **Create or select a realm** in Keycloak admin console
2. **Configure realm settings**:
   - Name: `master` (or custom realm)
   - Display name: `DemoBuilder Realm`
   - Enabled: `ON`

### Client Configuration

#### Basic Client Settings

1. **Create OIDC client**:
   - Client ID: `demobuilder`
   - Name: `DemoBuilder Infrastructure Assistant`
   - Protocol: `openid-connect`

2. **Client Authentication**:
   - Client authentication: `ON`
   - Authorization: `OFF`
   - Authentication flow: `Standard flow` only

3. **Valid Redirect URIs**:
   ```
   https://your-demobuilder-route/oauth2/callback
   ```

#### Client JSON Configuration
```json
{
  "clientId": "demobuilder",
  "name": "DemoBuilder Infrastructure Assistant",
  "description": "AI-powered multi-cloud infrastructure assistant",
  "protocol": "openid-connect",
  "clientAuthenticatorType": "client-secret",
  "redirectUris": [
    "https://demobuilder-dev.apps.cluster.example.com/oauth2/callback"
  ],
  "webOrigins": [
    "https://demobuilder-dev.apps.cluster.example.com"
  ],
  "standardFlowEnabled": true,
  "implicitFlowEnabled": false,
  "directAccessGrantsEnabled": false,
  "serviceAccountsEnabled": false,
  "publicClient": false,
  "frontchannelLogout": true,
  "protocol": "openid-connect",
  "attributes": {
    "saml.assertion.signature": "false",
    "saml.force.post.binding": "false",
    "saml.multivalued.roles": "false",
    "saml.encrypt": "false",
    "oauth2.device.authorization.grant.enabled": "false",
    "backchannel.logout.revoke.offline.tokens": "false",
    "saml.server.signature": "false",
    "saml.server.signature.keyinfo.ext": "false",
    "exclude.session.state.from.auth.response": "false",
    "oidc.ciba.grant.enabled": "false",
    "saml.artifact.binding": "false",
    "backchannel.logout.session.required": "true",
    "client_credentials.use_refresh_token": "false",
    "saml_force_name_id_format": "false",
    "require.pushed.authorization.requests": "false",
    "saml.client.signature": "false",
    "tls.client.certificate.bound.access.tokens": "false",
    "saml.authnstatement": "false",
    "display.on.consent.screen": "false",
    "saml.onetimeuse.condition": "false"
  }
}
```

### Role Configuration

#### Create Application Roles

1. **demobuilder-admin**:
   - Description: `Full administrative access to DemoBuilder`
   - Composite: `false`

2. **demobuilder-power**:
   - Description: `Power user with advanced features`
   - Composite: `false`

3. **demobuilder-user**:
   - Description: `Standard DemoBuilder user`
   - Composite: `false`

#### Role Mappings

Assign roles to users or groups:

1. **Users → Role Mappings**
2. **Assign client roles**:
   - Select `demobuilder` client
   - Assign appropriate roles

### User Management

#### Create Test Users

```json
{
  "username": "demo-admin",
  "email": "admin@example.com",
  "firstName": "Demo",
  "lastName": "Administrator",
  "enabled": true,
  "credentials": [{
    "type": "password",
    "value": "admin123",
    "temporary": false
  }],
  "clientRoles": {
    "demobuilder": ["demobuilder-admin"]
  }
}
```

## OAuth2 Proxy Configuration

### Proxy Settings

The OAuth2 Proxy configuration is automatically generated by the deployment script:

```ini
# OAuth2 Proxy Configuration for Keycloak
http_address = "0.0.0.0:4180"
metrics_address = "0.0.0.0:44180"

# Keycloak OIDC Configuration
provider = "keycloak-oidc"
provider_display_name = "Keycloak"

# Upstream configuration - points to demobuilder service
upstreams = ["http://demobuilder:8501"]

# Email configuration
email_domains = ["*"]

# Session configuration
cookie_name = "_oauth2_proxy_demobuilder"
cookie_secure = true
cookie_httponly = true
cookie_samesite = "lax"
cookie_expire = "168h"  # 7 days

# Security headers
set_xauthrequest = true
set_authorization_header = true
pass_basic_auth = false
pass_access_token = false
pass_user_headers = true

# Skip authentication for health checks
skip_auth_routes = [
  "^/ping$",
  "^/ready$",
  "^/_stcore/health$"
]

# Custom headers to pass user information
set_header_prefix = "X-Auth-Request-"
```

### Secret Management

OAuth2 Proxy requires these secrets:

```bash
# Cookie secret (auto-generated)
COOKIE_SECRET=$(openssl rand -base64 32)

# Keycloak client credentials
CLIENT_ID="demobuilder"
CLIENT_SECRET="your-keycloak-client-secret"

# OIDC issuer URL
OIDC_ISSUER_URL="https://keycloak.example.com/realms/master"
```

## DemoBuilder Integration

### Authentication Middleware

The `config/auth_config.py` module handles authentication:

```python
class AuthConfig:
    def __init__(self):
        self.enabled = self._is_auth_enabled()
        
    def _is_auth_enabled(self) -> bool:
        return os.getenv('KEYCLOAK_ENABLED', 'false').lower() in ['true', '1', 'yes']
    
    def get_current_user(self) -> Optional[UserInfo]:
        # Extract user info from OAuth2 Proxy headers
        headers = st.context.headers if hasattr(st.context, 'headers') else {}
        username = headers.get('X-Auth-Request-User')
        email = headers.get('X-Auth-Request-Email')
        # ... extract other user information
```

### User Information Extraction

OAuth2 Proxy sets these headers:

| Header | Description |
|--------|-------------|
| `X-Auth-Request-User` | Username from Keycloak |
| `X-Auth-Request-Email` | Email address |
| `X-Auth-Request-Preferred-Username` | Display name |
| `X-Auth-Request-Groups` | Comma-separated roles/groups |

### Role-Based Features

```python
def is_power_user() -> bool:
    auth_config = get_auth_config()
    return auth_config.has_any_role([
        'admin', 'power-user', 
        'demobuilder-admin', 'demobuilder-power'
    ])

@require_auth
def advanced_feature():
    # Feature only available to authenticated users
    pass
```

## Development and Testing

### Development Mode

For local development without OAuth2 Proxy:

```bash
export KEYCLOAK_ENABLED="false"
export AUTH_DEV_MODE="true"
export AUTH_DEV_USER="dev-user"
export AUTH_DEV_EMAIL="dev@example.com"
export AUTH_DEV_DISPLAY_NAME="Development User"
```

### Testing Authentication Flow

1. **Deploy with authentication enabled**
2. **Access the application URL**
3. **Verify redirect to Keycloak**
4. **Login with test credentials**
5. **Verify successful redirect back to DemoBuilder**
6. **Check user information in sidebar**

### Mock Authentication

For testing role-based features:

```python
# In development mode, you can override roles
os.environ['AUTH_DEV_ROLES'] = 'demobuilder-admin,demobuilder-power'
```

## Deployment Examples

### Basic Authentication Deployment

```bash
./deployment/openshift/deploy-s2i.sh \
  --namespace demobuilder-dev \
  --enable-auth \
  --keycloak-url https://keycloak.example.com \
  --client-secret your-client-secret
```

### Advanced Authentication Deployment

```bash
./deployment/openshift/deploy-s2i.sh \
  --namespace demobuilder-prod \
  --enable-auth \
  --keycloak-url https://sso.company.com \
  --realm company-realm \
  --client-id demobuilder-prod \
  --client-secret prod-secret \
  --route-host demobuilder.company.com
```

## Troubleshooting

### Common Authentication Issues

#### 1. Redirect URI Mismatch
**Error**: `Invalid redirect URI`
**Solution**: Ensure Keycloak client has correct redirect URI:
```
https://your-actual-route/oauth2/callback
```

#### 2. Client Secret Issues
**Error**: `Unauthorized client`
**Solution**: Verify client secret matches in both Keycloak and OpenShift:
```bash
oc get secret oauth2-proxy-secrets -o yaml -n demobuilder-dev
```

#### 3. Certificate Issues
**Error**: `Certificate verification failed`
**Solution**: Check TLS configuration and certificate trust

#### 4. Session Issues
**Error**: User not staying logged in
**Solution**: Check cookie configuration and domain settings

### Debug Commands

```bash
# Check OAuth2 Proxy logs
oc logs deployment/oauth2-proxy -n demobuilder-dev

# Check DemoBuilder logs for auth issues
oc logs deployment/demobuilder -n demobuilder-dev | grep -i auth

# Test OAuth2 Proxy endpoints
curl -I https://your-route/oauth2/ping
curl -I https://your-route/oauth2/auth

# Check secrets
oc describe secret oauth2-proxy-secrets -n demobuilder-dev
```

### Health Checks

Verify authentication components:

1. **OAuth2 Proxy health**: `https://your-route/oauth2/ping`
2. **Keycloak connectivity**: Check issuer URL access
3. **DemoBuilder authentication status**: Check sidebar user info
4. **Role assignments**: Verify power user features appear

## Security Considerations

### Cookie Security
- `Secure` flag: HTTPS only
- `HttpOnly` flag: Prevents XSS attacks
- `SameSite=Lax`: CSRF protection

### Session Management
- 7-day session timeout (configurable)
- Secure logout endpoint: `/oauth2/sign_out`
- Session invalidation on logout

### Network Security
- TLS termination at route level
- Internal communication over HTTP within cluster
- Network policies for pod-to-pod communication

### Secrets Management
- Kubernetes secrets for sensitive data
- No secrets in environment variables or logs
- Rotation capability for client secrets

## Production Recommendations

### High Availability
- Multiple OAuth2 Proxy replicas
- Keycloak cluster setup
- Session affinity configuration

### Monitoring
- OAuth2 Proxy metrics on port 44180
- Authentication success/failure rates
- Session duration tracking

### Backup and Recovery
- Keycloak database backups
- Client configuration exports
- Secret backup procedures